From 0491457deb85a1984a729beae2912f73ae9069e4 Mon Sep 17 00:00:00 2001
From: "Luke A. Guest" <laguest@archeia.com>
Date: Fri, 8 Aug 2014 16:48:57 +0100
Subject: [PATCH 1/5] Removal of VMS from the main source as it's not required.

---
 src/gprbind.adb         |  9 +------
 src/gprbuild-main.adb   | 68 +++++++++++++------------------------------------
 src/gprclean-main.adb   | 34 ++++++++-----------------
 src/gprconfig-main.adb  |  2 +-
 src/gprinstall-main.adb | 22 +++++-----------
 src/gprlib.adb          | 26 ++-----------------
 6 files changed, 40 insertions(+), 121 deletions(-)

diff --git a/src/gprbind.adb b/src/gprbind.adb
index 7bfefd2..e1bf878 100644
--- a/src/gprbind.adb
+++ b/src/gprbind.adb
@@ -50,8 +50,7 @@ procedure Gprbind is
      (C, Shared_Libgcc_Default, "__gnat_shared_libgcc_default");
 
    Preserve : Attribute := Time_Stamps;
-   --  Used in calls to Copy_File. Changed to None for OpenVMS, because
-   --  Copy_Attributes always fails on VMS.
+   --  Used in calls to Copy_File.
 
    Executable_Suffix : constant String_Access := Get_Executable_Suffix;
    --  The suffix of executables on this platforms
@@ -248,12 +247,6 @@ begin
 
    Namet.Initialize;
 
-   --  Copy_Attributes always fails on VMS
-
-   if Hostparm.OpenVMS then
-      Preserve := None;
-   end if;
-
    Exchange_File_Name := new String'(Argument (1));
 
    --  DEBUG: save a copy of the exchange file
diff --git a/src/gprbuild-main.adb b/src/gprbuild-main.adb
index 860ae23..0218c63 100644
--- a/src/gprbuild-main.adb
+++ b/src/gprbuild-main.adb
@@ -682,23 +682,11 @@ procedure Gprbuild.Main is
             end if;
 
          elsif Arg = "--db-" then
-            if Hostparm.OpenVMS then
-               Fail_Program
-                 (Project_Tree,
-                  "--db- cannot be used on VMS");
-            end if;
-
             Forbidden_In_Package_Builder;
 
             Load_Standard_Base := False;
 
          elsif Arg = "--db" then
-            if Hostparm.OpenVMS then
-               Fail_Program
-                 (Project_Tree,
-                  "--db cannot be used on VMS");
-            end if;
-
             Forbidden_In_Package_Builder;
 
             Db_Directory_Expected := True;
@@ -747,12 +735,6 @@ procedure Gprbuild.Main is
             Arg (1 .. Autoconf_Project_Option'Length) =
               Autoconf_Project_Option
          then
-            if Hostparm.OpenVMS then
-               Fail_Program
-                 (Project_Tree,
-                  Autoconf_Project_Option & " cannot be used on VMS");
-            end if;
-
             Forbidden_In_Package_Builder;
 
             if Config_Project_File_Name /= null
@@ -776,12 +758,6 @@ procedure Gprbuild.Main is
            and then
             Arg (1 .. Target_Project_Option'Length) = Target_Project_Option
          then
-            if Hostparm.OpenVMS then
-               Fail_Program
-                 (Project_Tree,
-                  Target_Project_Option & " cannot be used on VMS");
-            end if;
-
             Forbidden_In_Package_Builder;
 
             if Target_Name /= null then
@@ -1633,41 +1609,33 @@ procedure Gprbuild.Main is
 
          --  Line for Autoconf_Project_Option
 
-         if not Hostparm.OpenVMS then
-            Write_Str ("  ");
-            Write_Str (Autoconf_Project_Option);
-            Write_Str ("file.cgpr");
-            Write_Eol;
-            Write_Str
-              ("           Specify/create the main config project file name");
-            Write_Eol;
-         end if;
+         Write_Str ("  ");
+         Write_Str (Autoconf_Project_Option);
+         Write_Str ("file.cgpr");
+         Write_Eol;
+         Write_Str
+           ("           Specify/create the main config project file name");
+         Write_Eol;
 
          --  Line for Target_Project_Option
 
-         if not Hostparm.OpenVMS then
-            Write_Str ("  ");
-            Write_Str (Target_Project_Option);
-            Write_Str ("targetname");
-            Write_Eol;
-            Write_Str
-              ("           Specify a target for cross platforms");
-            Write_Eol;
-         end if;
+         Write_Str ("  ");
+         Write_Str (Target_Project_Option);
+         Write_Str ("targetname");
+         Write_Eol;
+         Write_Str
+           ("           Specify a target for cross platforms");
+         Write_Eol;
 
          --  Line for --db
 
-         if not Hostparm.OpenVMS then
-            Write_Str ("  --db dir Parse dir as an additional knowledge base");
-            Write_Eol;
-         end if;
+         Write_Str ("  --db dir Parse dir as an additional knowledge base");
+         Write_Eol;
 
          --  Line for --db-
 
-         if not Hostparm.OpenVMS then
-            Write_Str ("  --db-    Do not load the standard knowledge base");
-            Write_Eol;
-         end if;
+         Write_Str ("  --db-    Do not load the standard knowledge base");
+         Write_Eol;
 
          --  Line for --subdirs=
 
diff --git a/src/gprclean-main.adb b/src/gprclean-main.adb
index 8cac791..2a1297f 100644
--- a/src/gprclean-main.adb
+++ b/src/gprclean-main.adb
@@ -168,10 +168,10 @@ procedure Gprclean.Main is
 
                   case Arg (2) is
                      when '-' =>
-                        if not Hostparm.OpenVMS and then Arg = "--db-" then
+                        if Arg = "--db-" then
                            Load_Standard_Base := False;
 
-                        elsif not Hostparm.OpenVMS and then Arg = "--db" then
+                        elsif Arg = "--db" then
                            Db_Directory_Expected := True;
 
                         elsif Arg'Length > Config_Project_Option'Length
@@ -222,9 +222,7 @@ procedure Gprclean.Main is
                                    (Slave_Env_Option'Length + 2 .. Arg'Last));
                            end if;
 
-                        elsif not Hostparm.OpenVMS
-                              and then
-                                Arg'Length > Autoconf_Project_Option'Length
+                        elsif Arg'Length > Autoconf_Project_Option'Length
                               and then
                                 Arg (1 .. Autoconf_Project_Option'Length) =
                                 Autoconf_Project_Option
@@ -250,9 +248,7 @@ procedure Gprclean.Main is
                               Autoconf_Specified := True;
                            end if;
 
-                        elsif not Hostparm.OpenVMS
-                          and then
-                            Arg'Length > Target_Project_Option'Length
+                        elsif Arg'Length > Target_Project_Option'Length
                           and then
                             Arg (1 .. Target_Project_Option'Length) =
                                Target_Project_Option
@@ -557,24 +553,16 @@ procedure Gprclean.Main is
          Put_Line ("  --config=file.cgpr");
          Put_Line ("           Specify the configuration project file name");
 
-         if not Hostparm.OpenVMS then
-            Put_Line ("  --autoconf=file.cgpr");
-            Put_Line
-              ("           Specify/create the main config project file name");
-         end if;
+         Put_Line ("  --autoconf=file.cgpr");
+         Put_Line
+           ("           Specify/create the main config project file name");
 
-         if not Hostparm.OpenVMS then
-            Put_Line ("  --target=targetname");
-            Put_Line ("           Specify a target for cross platforms");
-         end if;
+         Put_Line ("  --target=targetname");
+         Put_Line ("           Specify a target for cross platforms");
 
-         if not Hostparm.OpenVMS then
-            Put_Line ("  --db dir Parse dir as an additional knowledge base");
-         end if;
+         Put_Line ("  --db dir Parse dir as an additional knowledge base");
 
-         if not Hostparm.OpenVMS then
-            Put_Line ("  --db-    Do not load the standard knowledge base");
-         end if;
+         Put_Line ("  --db-    Do not load the standard knowledge base");
 
          Put_Line ("  --RTS=<runtime>");
          Put_Line ("           Use runtime <runtime> for language Ada");
diff --git a/src/gprconfig-main.adb b/src/gprconfig-main.adb
index 476690a..70e3e80 100644
--- a/src/gprconfig-main.adb
+++ b/src/gprconfig-main.adb
@@ -476,7 +476,7 @@ begin
    Get_Targets_Set
      (Base, To_String (Selected_Target), Selected_Targets_Set);
 
-   if Batch or Hostparm.OpenVMS then
+   if Batch then
       Complete_Command_Line_Compilers
         (Base,
          Selected_Targets_Set,
diff --git a/src/gprinstall-main.adb b/src/gprinstall-main.adb
index f736eb6..d2bc3f4 100644
--- a/src/gprinstall-main.adb
+++ b/src/gprinstall-main.adb
@@ -224,12 +224,6 @@ procedure Gprinstall.Main is
             end if;
 
          elsif Has_Prefix (Autoconf_Project_Option) then
-            if Hostparm.OpenVMS then
-               Fail_Program
-                 (Project_Tree,
-                  Autoconf_Project_Option & " cannot be used on VMS");
-            end if;
-
             if Config_Project_File_Name /= null
               and then (not Autoconf_Specified
                         or else Config_Project_File_Name.all /=
@@ -601,15 +595,13 @@ procedure Gprinstall.Main is
 
          --  Line for Autoconf_Project_Option
 
-         if not Hostparm.OpenVMS then
-            Write_Str ("  ");
-            Write_Str (Autoconf_Project_Option);
-            Write_Str ("file.cgpr");
-            Write_Eol;
-            Write_Str
-              ("           Specify/create the main config project file name");
-            Write_Eol;
-         end if;
+         Write_Str ("  ");
+         Write_Str (Autoconf_Project_Option);
+         Write_Str ("file.cgpr");
+         Write_Eol;
+         Write_Str
+           ("           Specify/create the main config project file name");
+         Write_Eol;
 
          --  Line for --prefix
 
diff --git a/src/gprlib.adb b/src/gprlib.adb
index 3d81609..cc503a2 100644
--- a/src/gprlib.adb
+++ b/src/gprlib.adb
@@ -51,7 +51,6 @@ procedure Gprlib is
 
    Shared_Libgnat_Separator : Character := '-';
    --  Character between "-lgnat" or "-lgnarl" and the toolchain version.
-   --  It is not a constant because it is changed to '_' on VMS.
 
    Size           : Natural;
 
@@ -63,8 +62,7 @@ procedure Gprlib is
    Gcc_Name : constant String := "gcc";
 
    Preserve : Attribute := Time_Stamps;
-   --  Used by Copy_ALI_Files. Changed to None for OpenVMS, because
-   --  Copy_Attributes always fails on VMS.
+   --  Used by Copy_ALI_Files.
 
    Object_Suffix : constant String := Get_Target_Object_Suffix.all;
    --  The suffix of object files on this platform
@@ -654,7 +652,7 @@ procedure Gprlib is
                   S := new String (1 .. Len + 3);
 
                   --  Read the file. Note that the loop is not necessary
-                  --  since the whole file is read at once except on VMS.
+                  --  since the whole file is read at once.
 
                   Curr := 1;
                   Actual_Len := Len;
@@ -866,13 +864,6 @@ begin
    Namet.Initialize;
    Snames.Initialize;
 
-   --  Copy_Attributes always fails on VMS
-
-   if Hostparm.OpenVMS then
-      Preserve := None;
-      Shared_Libgnat_Separator := '_';
-   end if;
-
    if Argument_Count /= 1 then
       Put_Line ("usage: gprlib <input file>");
 
@@ -1170,17 +1161,6 @@ begin
                      GNAT_Version := new String'(Line (6 .. Last));
                      GNAT_Version_Set := True;
 
-                     --  On VMS, replace all '.' with '_', to avoid names with
-                     --  several dots.
-
-                     if Hostparm.OpenVMS then
-                        for J in 6 .. Last loop
-                           if Line (J) = '.' then
-                              Line (J) := '_';
-                           end if;
-                        end loop;
-                     end if;
-
                      Libgnat :=
                        new String'
                          ("-lgnat" &
@@ -2138,8 +2118,6 @@ begin
 
       --  Osint.Add_Default_Search_Dirs;
 
-      --  Check if the platform is VMS and, if it is, change some variables
-
       --  Targparm.Get_Target_Parameters;
 
       Prj.Initialize (Prj.No_Project_Tree);
-- 
1.8.5.5

